{"ast":null,"code":"var __rest = this && this.__rest || function (s, e) {\n  var t = {};\n  for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0) t[p] = s[p];\n  if (s != null && typeof Object.getOwnPropertySymbols === \"function\") for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\n    if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i])) t[p[i]] = s[p[i]];\n  }\n  return t;\n};\nimport { useEffect } from 'react';\nimport { useQuery, useQueryClient } from '@tanstack/react-query';\nimport debounce from 'lodash.debounce';\nimport { WebSocketEventEnum } from '@novu/shared';\nimport { useNovuContext } from './useNovuContext';\nimport { useSetQueryKey } from './useSetQueryKey';\nimport { useFetchNotificationsQueryKey } from './useFetchNotificationsQueryKey';\nimport { useUnseenCountQueryKey } from './useUnseenCountQueryKey';\nimport { useDataRef } from './useDataRef';\nimport { FEED_UNSEEN_COUNT_QUERY_KEY } from './queryKeys';\nimport { useUnreadCountQueryKey } from './useUnreadCountQueryKey';\nconst dispatchUnreadCountEvent = count => {\n  document.dispatchEvent(new CustomEvent('novu:unread_count_changed', {\n    detail: count\n  }));\n};\n/**\n * TODO: This is a temporary fix\n * Cypress is slow, so we need to increase the debounce time\n * This is happening in a very high thruput of updates in testing env.\n *\n * Can also happen in real scenarios, so we need to review how we handle concurrency in the future\n */\nconst DEBOUNCE_TIME = typeof window !== 'undefined' && (window === null || window === void 0 ? void 0 : window.Cypress) ? 1000 : 100;\nexport const useUnreadCount = (_a = {}) => {\n  var {\n      onSuccess\n    } = _a,\n    restOptions = __rest(_a, [\"onSuccess\"]);\n  const {\n    apiService,\n    socket,\n    isSessionInitialized,\n    fetchingStrategy\n  } = useNovuContext();\n  const queryClient = useQueryClient();\n  const setQueryKey = useSetQueryKey();\n  const fetchNotificationsQueryKey = useFetchNotificationsQueryKey();\n  const unreadCountQueryKey = useUnreadCountQueryKey();\n  const unseenCountQueryKey = useUnseenCountQueryKey();\n  const queryKeysRef = useDataRef({\n    fetchNotificationsQueryKey,\n    unreadCountQueryKey,\n    unseenCountQueryKey\n  });\n  useEffect(() => {\n    if (!socket) {\n      return () => {};\n    }\n    socket.on(WebSocketEventEnum.UNREAD, debounce(data => {\n      if (Number.isInteger(data === null || data === void 0 ? void 0 : data.unreadCount)) {\n        queryClient.setQueryData(queryKeysRef.current.unreadCountQueryKey, oldData => {\n          var _a;\n          return {\n            count: (_a = data === null || data === void 0 ? void 0 : data.unreadCount) !== null && _a !== void 0 ? _a : oldData.count\n          };\n        });\n        // when unread count changes, we need to refetch unseen count\n        queryClient.refetchQueries(queryKeysRef.current.unseenCountQueryKey, {\n          exact: false\n        });\n        queryClient.refetchQueries(queryKeysRef.current.fetchNotificationsQueryKey, {\n          exact: false\n        });\n        // refetch all feeds unseen count that is shown on the tabs\n        queryClient.refetchQueries([...FEED_UNSEEN_COUNT_QUERY_KEY], {\n          exact: false\n        });\n        dispatchUnreadCountEvent(data.unreadCount);\n      }\n    }, DEBOUNCE_TIME));\n    return () => {\n      socket.off(WebSocketEventEnum.UNSEEN);\n    };\n  }, [socket, queryClient, setQueryKey]);\n  const result = useQuery(unreadCountQueryKey, () => apiService.getUnreadCount({\n    limit: 100\n  }), Object.assign(Object.assign({}, restOptions), {\n    enabled: isSessionInitialized && fetchingStrategy.fetchUnseenCount,\n    onSuccess: data => {\n      dispatchUnreadCountEvent(data.count);\n      onSuccess === null || onSuccess === void 0 ? void 0 : onSuccess(data);\n    }\n  }));\n  return result;\n};","map":{"version":3,"names":["useEffect","useQuery","useQueryClient","debounce","WebSocketEventEnum","useNovuContext","useSetQueryKey","useFetchNotificationsQueryKey","useUnseenCountQueryKey","useDataRef","FEED_UNSEEN_COUNT_QUERY_KEY","useUnreadCountQueryKey","dispatchUnreadCountEvent","count","document","dispatchEvent","CustomEvent","detail","DEBOUNCE_TIME","window","Cypress","useUnreadCount","_a","onSuccess","restOptions","__rest","apiService","socket","isSessionInitialized","fetchingStrategy","queryClient","setQueryKey","fetchNotificationsQueryKey","unreadCountQueryKey","unseenCountQueryKey","queryKeysRef","on","UNREAD","data","Number","isInteger","unreadCount","setQueryData","current","oldData","refetchQueries","exact","off","UNSEEN","result","getUnreadCount","limit","Object","assign","enabled","fetchUnseenCount"],"sources":["../../../src/hooks/useUnreadCount.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}