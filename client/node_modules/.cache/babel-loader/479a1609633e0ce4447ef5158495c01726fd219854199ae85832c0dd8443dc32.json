{"ast":null,"code":"var __rest = this && this.__rest || function (s, e) {\n  var t = {};\n  for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0) t[p] = s[p];\n  if (s != null && typeof Object.getOwnPropertySymbols === \"function\") for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\n    if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i])) t[p[i]] = s[p[i]];\n  }\n  return t;\n};\nimport { useEffect } from 'react';\nimport { useQuery, useQueryClient } from '@tanstack/react-query';\nimport debounce from 'lodash.debounce';\nimport { WebSocketEventEnum } from '@novu/shared';\nimport { useNovuContext } from './useNovuContext';\nimport { useSetQueryKey } from './useSetQueryKey';\nimport { useFetchNotificationsQueryKey } from './useFetchNotificationsQueryKey';\nimport { useUnseenCountQueryKey } from './useUnseenCountQueryKey';\nimport { useDataRef } from './useDataRef';\nimport { FEED_UNSEEN_COUNT_QUERY_KEY } from './queryKeys';\nconst dispatchUnseenCountEvent = count => {\n  document.dispatchEvent(new CustomEvent('novu:unseen_count_changed', {\n    detail: count\n  }));\n};\n/**\n * TODO: This is a temporary fix\n * Cypress is slow, so we need to increase the debounce time\n * This is happening in a very high thruput of updates in testing env.\n *\n * Can also happen in real scenarios, so we need to review how we handle concurrency in the future\n */\nconst DEBOUNCE_TIME = typeof window !== 'undefined' && (window === null || window === void 0 ? void 0 : window.Cypress) ? 1000 : 100;\nexport const useUnseenCount = (_a = {}) => {\n  var {\n      onSuccess\n    } = _a,\n    restOptions = __rest(_a, [\"onSuccess\"]);\n  const {\n    apiService,\n    socket,\n    isSessionInitialized,\n    fetchingStrategy\n  } = useNovuContext();\n  const queryClient = useQueryClient();\n  const setQueryKey = useSetQueryKey();\n  const fetchNotificationsQueryKey = useFetchNotificationsQueryKey();\n  const unseenCountQueryKey = useUnseenCountQueryKey();\n  const queryKeysRef = useDataRef({\n    fetchNotificationsQueryKey,\n    unseenCountQueryKey\n  });\n  useEffect(() => {\n    if (!socket) {\n      return () => {};\n    }\n    socket.on(WebSocketEventEnum.UNSEEN, debounce(data => {\n      if (Number.isInteger(data === null || data === void 0 ? void 0 : data.unseenCount)) {\n        queryClient.setQueryData(unseenCountQueryKey, oldData => {\n          var _a;\n          return {\n            count: (_a = data === null || data === void 0 ? void 0 : data.unseenCount) !== null && _a !== void 0 ? _a : oldData.count\n          };\n        });\n        queryClient.refetchQueries(queryKeysRef.current.fetchNotificationsQueryKey, {\n          exact: false\n        });\n        // refetch all feeds unseen count that is shown on the tabs\n        queryClient.refetchQueries([...FEED_UNSEEN_COUNT_QUERY_KEY], {\n          exact: false\n        });\n        dispatchUnseenCountEvent(data.unseenCount);\n      }\n    }, DEBOUNCE_TIME));\n    return () => {\n      socket.off(WebSocketEventEnum.UNSEEN);\n    };\n  }, [socket, queryClient, setQueryKey]);\n  const result = useQuery(unseenCountQueryKey, () => apiService.getUnseenCount({\n    limit: 100\n  }), Object.assign(Object.assign({}, restOptions), {\n    enabled: isSessionInitialized && fetchingStrategy.fetchUnseenCount,\n    onSuccess: data => {\n      dispatchUnseenCountEvent(data.count);\n      onSuccess === null || onSuccess === void 0 ? void 0 : onSuccess(data);\n    }\n  }));\n  return result;\n};","map":{"version":3,"names":["useEffect","useQuery","useQueryClient","debounce","WebSocketEventEnum","useNovuContext","useSetQueryKey","useFetchNotificationsQueryKey","useUnseenCountQueryKey","useDataRef","FEED_UNSEEN_COUNT_QUERY_KEY","dispatchUnseenCountEvent","count","document","dispatchEvent","CustomEvent","detail","DEBOUNCE_TIME","window","Cypress","useUnseenCount","_a","onSuccess","restOptions","__rest","apiService","socket","isSessionInitialized","fetchingStrategy","queryClient","setQueryKey","fetchNotificationsQueryKey","unseenCountQueryKey","queryKeysRef","on","UNSEEN","data","Number","isInteger","unseenCount","setQueryData","oldData","refetchQueries","current","exact","off","result","getUnseenCount","limit","Object","assign","enabled","fetchUnseenCount"],"sources":["../../../src/hooks/useUnseenCount.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}